# Объяснение работы ритривера и оптимизации токенов

## Что такое `data/generated/`?

**`data/generated/`** - это директория, где хранятся **сгенерированные проекты** (ground truth проекты), созданные в Phase 1 и Phase 2:

1. **Phase 1**: Генерирует спецификации проектов → `data/generated/specifications/`
2. **Phase 2**: Генерирует полные кодовые базы → `data/generated/codebases/` или `data/generated/{project_name}/`
3. **Phase 3**: Использует эти проекты для создания сценариев оценки → `data/output/scenarios/`

## Разница между генерацией сценариев и оценкой моделей

### Phase 3: Генерация сценариев (`scenario_generator.py`)

Когда система **генерирует сценарии** (Phase 3), она:
- Загружает проекты из `data/generated/`
- Выбирает подмножество файлов для контекста
- **НЕ передает полное содержимое файлов** в промпт LLM
- Вместо этого передает только **summary** (метаданные):
  ```python
  files_summary.append(f"- {file_path}: {lines} lines, {chars} chars")
  ```
- Это экономит токены при генерации сценариев ✅

### Phase 4: Оценка моделей (`evaluator.py`)

Когда система **оценивает модели** (Phase 4), она:
- Загружает сценарии из `data/output/scenarios/`
- Сценарии содержат список `context_files` (пути к файлам)
- Ритривер пытается загрузить **полное содержимое** этих файлов из `data/generated/`
- Если ритривер включен, он выбирает top-K релевантных фрагментов
- Если ритривер выключен или файлы не найдены, система работает без контекста

## Проблема с токенами

### Текущая ситуация:

1. **При генерации сценариев** (Phase 3):
   - ✅ Экономия токенов: передается только summary файлов (~100-500 токенов)

2. **При оценке моделей** (Phase 4):
   - ❌ Проблема: если ритривер не работает (файлы не найдены), модель получает только список путей к файлам
   - ❌ Если бы ритривер работал, он передавал бы top-K фрагментов (экономия токенов)
   - ⚠️ Если передавать все файлы целиком, это может быть очень дорого (100K-1M токенов)

## Что делает ритривер?

Ритривер (Retrieval-Augmented Generation) - это механизм оптимизации:

1. **Загружает контекстные файлы** из `data/generated/{project_name}/`
2. **Разбивает их на чанки** (~512 символов каждый)
3. **Использует embeddings** (векторные представления) для поиска релевантных фрагментов
4. **Выбирает top-K** (по умолчанию 5) наиболее релевантных фрагментов
5. **Передает только эти фрагменты** модели вместо всех файлов

### Преимущества:
- ✅ Экономия токенов: вместо 100K токенов передается ~5-10K токенов
- ✅ Лучшая релевантность: модель получает только нужный код
- ✅ Масштабируемость: работает с большими проектами

### Проблема в вашем случае:
- ❌ Файлы не найдены в `data/generated/`
- ❌ Ритривер не может загрузить контекст
- ⚠️ Модель работает без контекста кода проекта

## Оптимизация промпта для генерации сценариев

Вы правы - в `scenario_generator.py` промпт уже оптимизирован:

```python
# Строки 752-758: создается только summary
files_summary.append(f"- {file_path}: {lines} lines, {chars} chars")
context_summary = "\n".join(files_summary)

# В промпт передается только summary, а не полное содержимое
AVAILABLE FILES:
{context_summary}  # Только метаданные!
```

Это правильно и экономит токены при генерации сценариев.

## Что было добавлено

## Рекомендации

1. **Для генерации сценариев** (Phase 3):
   - ✅ Текущий подход правильный - передается только summary
   - ✅ Не нужно менять

2. **Для оценки моделей** (Phase 4):
   - ✅ Убедитесь, что `data/generated/` содержит проекты
   - ✅ Включите ритривер для экономии токенов
   - ✅ Ритривер автоматически выберет релевантные фрагменты

3. **Мониторинг токенов**:
   - ✅ Теперь вы видите количество токенов в логах
   - ✅ Используйте это для оптимизации промптов

## Конфигурация ритривера

В `config.yaml`:
```yaml
retrieval:
  enabled: true              # Включен
  difficulties: [hard, expert]  # Только для сложных задач
  method: embedding           # Использует embeddings
  top_k: 5                    # Берет 5 самых релевантных фрагментов
  chunk_size: 512             # Размер чанка
```

Это оптимальная конфигурация для экономии токенов при сохранении качества.
